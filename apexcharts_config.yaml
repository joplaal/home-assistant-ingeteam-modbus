type: custom:apexcharts-card
header:
  show: true
  title: Balance Energético
  show_states: true
  colorize_states: true
graph_span: 24h
span:
  start: day
now:
  show: true
  label: Ahora
yaxis:
  - id: power
    min: 0
    decimals: 0
    apex_config:
      title:
        text: Potencia (W)
  - id: soc
    min: 0
    max: 100
    opposite: true
    decimals: 0
    apex_config:
      title:
        text: SOC (%)
      tickAmount: 5
series:
  # --- SOC ---
  - entity: sensor.ingeteam_battery_state_of_charge
    name: SOC
    type: line
    yaxis_id: soc
    color: '#9e9e9e'
    stroke_width: 2
    extend_to: now
    show:
      legend_value: false
      in_header: true
    group_by:
      func: last
      duration: 5m

  # --- CONSUMO (Línea de referencia) ---
  # 1. Valor actual
  - entity: sensor.ingeteam_total_loads_power
    name: Consumo
    color: '#444444'
    show:
      in_chart: false
      in_header: true
    group_by:
      func: last
      duration: 5m
  # 2. Gráfica
  - entity: sensor.ingeteam_total_loads_power
    name: Consumo
    type: line
    yaxis_id: power
    color: '#444444'
    stroke_width: 2
    extend_to: now
    show:
      in_header: false
    group_by:
      func: avg
      duration: 5m

  # --- FUENTES DE ENERGÍA (Apiladas) ---
  # Al activar stacked: true globalmente, todas las series tipo 'area' se apilan automáticamente.
  
  # 1. FOTOVOLTAICA
  - entity: sensor.ingeteam_pv_total_power
    name: Fotovoltaica
    color: '#FFD700'
    show:
      in_chart: false
      in_header: true
    group_by:
      func: last
      duration: 5m
  - entity: sensor.ingeteam_pv_total_power
    name: Fotovoltaica
    type: area
    yaxis_id: power
    color: '#FFD700'
    opacity: 0.6
    stroke_width: 0
    extend_to: now
    show:
      in_header: false
    group_by:
      func: avg
      duration: 5m

  # 2. DESCARGA BATERÍA
  - entity: sensor.ingeteam_battery_discharging_power
    name: Descarga Bat
    color: '#4CAF50'
    show:
      in_chart: false
      in_header: true
    group_by:
      func: last
      duration: 5m
  - entity: sensor.ingeteam_battery_discharging_power
    name: Descarga Batería
    type: area
    yaxis_id: power
    color: '#4CAF50'
    opacity: 0.7
    stroke_width: 0
    extend_to: now
    show:
      in_header: false
    group_by:
      func: avg
      duration: 5m

  # 3. RED (IMPORT)
  - entity: sensor.ingeteam_grid_power_balance
    name: Red (Import)
    color: '#2196F3'
    transform: 'return x > 0 ? x : 0;'
    show:
      in_chart: false
      in_header: true
    group_by:
      func: last
      duration: 5m
  - entity: sensor.ingeteam_grid_power_balance
    name: Red (Import)
    type: area
    yaxis_id: power
    color: '#2196F3'
    opacity: 0.7
    stroke_width: 0
    transform: 'return x > 0 ? x : 0;'
    extend_to: now
    show:
      in_header: false
    group_by:
      func: avg
      duration: 5m

  # --- CARGA BATERÍA (Independiente) ---
  # Cambiamos a 'line' para que NO se apile con las fuentes.
  - entity: sensor.ingeteam_battery_charging_power
    name: Carga Bat
    color: '#FF8C00'
    show:
      in_chart: false
      in_header: true
    group_by:
      func: last
      duration: 5m
  - entity: sensor.ingeteam_battery_charging_power
    name: Carga Batería
    type: line
    yaxis_id: power
    color: '#FF8C00'
    stroke_width: 2
    extend_to: now
    show:
      in_header: false
    group_by:
      func: avg
      duration: 5m

apex_config:
  chart:
    height: 450px
    stacked: true
  legend:
    position: bottom
  stroke:
    curve: smooth
  fill:
    type: solid
grid_options:
  columns: full
