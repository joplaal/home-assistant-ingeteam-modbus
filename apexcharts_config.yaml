type: custom:plotly-graph

# Default styling and stacking behavior for traces
defaults:
  entity:
    type: scatter
    mode: lines
    stackgroup: energy
    fill: tonexty
    line:
      width: 2
    hovertemplate: |
      $fn ({ get }) => (
        `%{y:,.0f} ${get('.unit_of_measurement')}<extra>${get('.name')}</extra>`
      )
  yaxes:
    rangemode: nonnegative
    zeroline: true

# Show current natural day by default
hours_to_show: current_day
extend_to_present: true
autorange_after_scroll: true
refresh_interval: auto

entities:
  # Visible stacked power traces
  - entity: sensor.ingeteam_pv_total_power
    name: FV
    fill: tozeroy
    line:
      color: "#FFA62B" # light orange
    filters:
      - resample: 5m
      - force_numeric
  - entity: sensor.ingeteam_battery_discharging_power
    name: Batería descarga
    line:
      color: "#2ECC71" # green
    filters:
      - resample: 5m
      - force_numeric
  - entity: sensor.ingeteam_battery_charging_power
    name: Batería carga
    line:
      color: "#8A3A00" # very dark orange
    filters:
      - resample: 5m
      - force_numeric
  - entity: sensor.ingeteam_grid_power_balance
    name: Red (import)
    line:
      color: "#0D47A1" # dark blue
    filters:
      - resample: 5m
      - force_numeric
      - map_y_numbers: Math.max(0, +y) # clamp negatives

  # Internal traces to compute today's kWh totals (integrate power -> energy)
  - entity: sensor.ingeteam_pv_total_power
    internal: true
    period: 5minute
    filters:
      - resample: 5m
      - force_numeric
      - integrate: h   # Wh
      - multiply: 0.001 # kWh
      - store_var: pv_kwh
  - entity: sensor.ingeteam_battery_discharging_power
    internal: true
    period: 5minute
    filters:
      - resample: 5m
      - force_numeric
      - integrate: h
      - multiply: 0.001
      - store_var: bat_discharge_kwh
  - entity: sensor.ingeteam_battery_charging_power
    internal: true
    period: 5minute
    filters:
      - resample: 5m
      - force_numeric
      - integrate: h
      - multiply: 0.001
      - store_var: bat_charge_kwh
  - entity: sensor.ingeteam_grid_power_balance
    internal: true
    period: 5minute
    filters:
      - resample: 5m
      - force_numeric
      - map_y_numbers: Math.max(0, +y)
      - integrate: h
      - multiply: 0.001
      - store_var: grid_kwh

layout:
  margin:
    t: 60
    r: 10
    b: 70
    l: 45
  legend:
    orientation: h
    x: 0
    xanchor: left
    y: -0.2
    yanchor: top
  title:
    text: |
      $ex {
        const fmt = (v) => `${((v ?? 0)).toFixed(2)} kWh`;
        const pv = vars.pv_kwh?.ys?.at(-1);
        const bd = vars.bat_discharge_kwh?.ys?.at(-1);
        const bc = vars.bat_charge_kwh?.ys?.at(-1);
        const gr = vars.grid_kwh?.ys?.at(-1);
        return `Hoy · FV: ${fmt(pv)} • Bat↓: ${fmt(bd)} • Bat↑: ${fmt(bc)} • Red: ${fmt(gr)}`;
      }
    x: 0
    xanchor: left
    font:
      size: 12
  xaxis:
    showspikes: true
    spikemode: across
    spikethickness: -2
    rangeselector:
      x: 1
      y: 1.05
      buttons:
        - label: Hoy
          step: day
          count: 1
        - label: 12h
          step: hour
          count: 12
        - label: Semana
          step: day
          count: 7
    rangeslider:
      visible: false

config:
  scrollZoom: true
